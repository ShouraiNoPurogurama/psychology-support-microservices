name: Deploy to VPS (Compose Pull+Up + Auto Health)

on:
  workflow_run:
    workflows: [ "Build & Push Microservices (GHCR)" ]
    types: [ completed ]
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (detect diff on VPS + selective pull/up)
        uses: appleboy/ssh-action@master
        env:
          # DÃ¹ng 'main' Ä‘á»ƒ trÃ¡nh manifest unknown khi service khÃ´ng build theo SHA
          NEW_TAG: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 30m
          script: |
            set -euo pipefail

            WORKDIR="/home/emoease/PsychologySupport"
            COMPOSE="docker-compose-apis.yml"

            cd "$WORKDIR"

            echo "ðŸ“ Láº¥y má»‘c commit cÅ© (náº¿u cÃ³)"
            OLD_COMMIT="$(cat .deploy_commit 2>/dev/null || git rev-parse HEAD)"

            echo "ðŸ“ Git pull main"
            git reset --hard
            git pull origin main

            NEW_COMMIT="$(git rev-parse HEAD)"
            echo "Diff range: ${OLD_COMMIT}..${NEW_COMMIT}"

            echo "ðŸ” Login GHCR"
            echo "${{ secrets.GIT_CONTAINER_REGISTRY_PASSWORD }}" | docker login ghcr.io -u "${{ secrets.GIT_CONTAINER_REGISTRY_USERNAME }}" --password-stdin

            echo "ðŸ“ Set IMAGE_TAG=${NEW_TAG}"
            cp -f .env ".env.backup.$(date +%s)" || true
            touch .env
            set_kv () {
              local k="$1"; local v="$2"
              if grep -qE "^${k}=" .env; then
                sed -i "s|^${k}=.*|${k}=${v}|" .env
              else
                echo "${k}=${v}" >> .env
              fi
            }
            set_kv IMAGE_TAG "${NEW_TAG}"
            echo "ðŸ“„ .env hiá»‡n táº¡i:"; cat .env || true

            echo "ðŸ§® TÃ­nh file thay Ä‘á»•i"
            mapfile -t CHANGED_FILES < <(git diff --name-only --diff-filter=ACMR "${OLD_COMMIT}".."${NEW_COMMIT}" || true)

            echo "ðŸ§­ Map folder â†’ service (giá»‘ng logic build)"
            ALL_SERVICES=(
              "alias.api" "auth.api" "chatbox.api" "feed.api" "media.api"
              "payment.api" "post.api" "profile.api" "promotion.grpc"
              "subscription.api" "test.api" "translation.api" "yarpapigateway"
            )

            declare -A SVC_SET=()
            add_svc(){ SVC_SET["$1"]=1; }

            if [ ${#CHANGED_FILES[@]} -eq 0 ]; then
              echo "âš ï¸ KhÃ´ng cÃ³ file thay Ä‘á»•i (cÃ³ thá»ƒ láº§n Ä‘áº§u deploy) â†’ deploy all (tag: ${NEW_TAG})"
              for s in "${ALL_SERVICES[@]}"; do add_svc "$s"; done
            else
              for f in "${CHANGED_FILES[@]}"; do
                case "$f" in
                  Services/Alias/Alias.API/*|PsychologySupport/Services/Alias/Alias.API/*)                     add_svc "alias.api" ;;
                  Services/Auth/Auth.API/*|PsychologySupport/Services/Auth/Auth.API/*)                         add_svc "auth.api" ;;
                  Services/ChatBox/ChatBox.API/*|PsychologySupport/Services/ChatBox/ChatBox.API/*)             add_svc "chatbox.api" ;;
                  Services/Feed/Feed.API/*|PsychologySupport/Services/Feed/Feed.API/*)                         add_svc "feed.api" ;;
                  Services/Media/Media.API/*|PsychologySupport/Services/Media/Media.API/*)                     add_svc "media.api" ;;
                  Services/Payment/Payment.API/*|PsychologySupport/Services/Payment/Payment.API/*)             add_svc "payment.api" ;;
                  Services/Post/Post.API/*|PsychologySupport/Services/Post/Post.API/*)                         add_svc "post.api" ;;
                  Services/Profile/Profile.API/*|PsychologySupport/Services/Profile/Profile.API/*)             add_svc "profile.api" ;;
                  Services/Promotion/Promotion.Grpc/*|PsychologySupport/Services/Promotion/Promotion.Grpc/*)   add_svc "promotion.grpc" ;;
                  Services/Subscription/Subscription.API/*|PsychologySupport/Services/Subscription/Subscription.API/*) add_svc "subscription.api" ;;
                  Services/Test/Test.API/*|PsychologySupport/Services/Test/Test.API/*)                         add_svc "test.api" ;;
                  Services/Translation/Translation.API/*|PsychologySupport/Services/Translation/Translation.API/*) add_svc "translation.api" ;;
                  ApiGateways/YarpApiGateway/*|PsychologySupport/ApiGateways/YarpApiGateway/*)                 add_svc "yarpapigateway" ;;
                  Directory.Packages.props|nuget.config|packages.lock.json|.dockerignore|docker-compose-apis.yml|BuildingBlocks/*|BuildingBlocks.Messaging/*|PsychologySupport/BuildingBlocks/*|PsychologySupport/BuildingBlocks.Messaging/*)
                    for s in "${ALL_SERVICES[@]}"; do add_svc "$s"; done ;;
                esac
              done
            fi

            # Náº¿u váº«n rá»—ng (edge-case) â†’ deploy all
            if [ ${#SVC_SET[@]} -eq 0 ]; then
              echo "âš ï¸ KhÃ´ng detect Ä‘Æ°á»£c service nÃ o â†’ deploy all (tag: ${NEW_TAG})"
              for s in "${ALL_SERVICES[@]}"; do add_svc "$s"; done
            fi

            # Káº¿t xuáº¥t danh sÃ¡ch service
            mapfile -t SERVICES < <(printf '%s\n' "${!SVC_SET[@]}" | sort)
            echo "ðŸ§© Sáº½ deploy cÃ¡c service:"
            printf ' - %s\n' "${SERVICES[@]}"

            echo "ðŸ“¥ Pull + ðŸš€ Up (chá»‰ services Ä‘Ã£ chá»n)"
            for s in "${SERVICES[@]}"; do
              echo "ðŸ“¥ Pull $s"
              docker compose -f "${COMPOSE}" pull "$s" || true
              echo "ðŸš€ Up $s"
              docker compose -f "${COMPOSE}" up -d "$s"
            done

            # ====== Health-check gá»n cho cÃ¡c service vá»«a deploy ======
            get_label() {
              docker inspect -f '{{ index .Config.Labels "'"$2"'" }}' "$1" 2>/dev/null || true
            }
            wait_container_healthy() {
              local name="$1"; local max_wait=60; local waited=0
              while true; do
                state="$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "$name" 2>/dev/null || echo none)"
                if [ "$state" = "healthy" ]; then
                  echo "âœ… $name HEALTHCHECK: healthy"; return 0
                fi
                if [ "$state" = "none" ]; then return 2; fi
                if [ $waited -ge $max_wait ]; then
                  echo "âŒ $name HEALTHCHECK timeout"; return 1
                fi
                sleep 2; waited=$((waited+2))
                echo "â³ Waiting $name HEALTHCHECK... ($waited/$max_wait)"
              done
            }
            http_health() {
              local svc="$1"; local cname="$2"
              local path="$(get_label "$cname" 'com.emoease.health_path')"
              local port_override="$(get_label "$cname" 'com.emoease.health_port')"
              local max_wait=60; local waited=0
              [ -z "$path" ] && path="/health"
              local host_port=""
              if [ -n "$port_override" ]; then
                host_port="$port_override"
              else
                host_port="$(docker compose -f "${COMPOSE}" port "$svc" 8080 | head -n1 | awk -F: '{print $NF}')"
                if [ -z "$host_port" ]; then
                  host_port="$(docker compose -f "${COMPOSE}" port "$svc" 80 | head -n1 | awk -F: '{print $NF}')"
                fi
              fi
              [ -z "$host_port" ] && { echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y host port cho $svc, skip HTTP health."; return 0; }
              while true; do
                if curl -fsS "http://localhost:${host_port}${path}" | grep -q '"status":"Healthy"'; then
                  echo "âœ… $svc HTTP ${path} OK (:${host_port})"; return 0
                fi
                if [ $waited -ge $max_wait ]; then
                  echo "âŒ $svc HTTP health timeout (${path} on :${host_port})"; return 1
                fi
                sleep 2; waited=$((waited+2))
                echo "â³ Waiting $svc HTTP health... ($waited/$max_wait)"
              done
            }

            echo "ðŸ©º Health-check cÃ¡c service vá»«a deploy"
            for svc in "${SERVICES[@]}"; do
              cname="$(docker compose -f "${COMPOSE}" ps -q "$svc" | xargs -r docker inspect --format '{{.Name}}' | sed 's#^/##' || true)"
              [ -z "$cname" ] && { echo "  âš ï¸ KhÃ´ng tÃ¬m tháº¥y container cho $svc, bá» qua health."; continue; }
              skip="$(get_label "$cname" 'com.emoease.health_skip')"
              if [ "$skip" = "true" ]; then
                echo "  Skip health for $svc (label com.emoease.health_skip=true)"; continue
              fi
              if wait_container_healthy "$cname"; then
                continue
              elif [ $? -eq 2 ]; then
                http_health "$svc" "$cname" || {
                  echo "âŒ Health fail on $svc â†’ rollback .env "
                  cp -f .env.backup.* .env 2>/dev/null || true
                  docker compose -f "${COMPOSE}" up -d "$svc"
                  exit 1
                }
              else
                echo "âŒ Health fail on $svc â†’ rollback .env "
                cp -f .env.backup.* .env 2>/dev/null || true
                docker compose -f "${COMPOSE}" up -d "$svc"
                exit 1
              fi
            done

            echo "ðŸ§­ Ghi má»‘c commit má»›i"
            echo "${NEW_COMMIT}" > .deploy_commit

            echo "ðŸ§¹ Cleanup dangling"
            docker image prune -f
