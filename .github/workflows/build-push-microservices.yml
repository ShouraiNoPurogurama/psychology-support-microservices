name: Build & Push Microservices (GHCR)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  # 0) Chá»n runner Æ°u tiÃªn
  pick-runner:
    runs-on: ubuntu-latest
    outputs:
      runs_on: ${{ steps.decide.outputs.runs_on }}
    steps:
      - name: Decide runner (prefer self-hosted "NA Self Hosted Runner")
        id: decide
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RUNNER_ADMIN_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            core.startGroup('ğŸ“¦ Fetching runners list from GitHub API');
            const res = await github.rest.actions.listSelfHostedRunnersForRepo({ owner, repo, per_page: 100 });
            core.info(`Raw API status: ${res.status}`);
            core.info(`Raw API response (first 500 chars): ${JSON.stringify(res.data, null, 2).slice(0, 500)}...`);
            core.endGroup();

            const runners = res.data.runners ?? [];
            if (runners.length === 0) {
              core.warning('âš ï¸ No runners found for this repo.');
            }

            core.startGroup('ğŸ“‹ Runners summary');
            for (const r of runners) {
              const labels = (r.labels||[]).map(l => l.name).join(', ');
              core.info(`â†’ name="${r.name}", status=${r.status}, busy=${r.busy}, labels=[${labels}]`);
            }
            core.endGroup();

            const target = 'na self hosted runner'; // match theo name hoáº·c label
            const wanted = runners.find(r => {
              const labels = (r.labels || []).map(l => (l.name || '').toLowerCase());
              const nameLc = (r.name || '').toLowerCase();
              return (labels.includes(target) || nameLc === target) && r.status === 'online' && !r.busy;
            });

            if (wanted) {
              const labelNames = (wanted.labels || []).map(l => l.name).filter(Boolean);
              if (!labelNames.map(s=>s.toLowerCase()).includes('self-hosted')) labelNames.unshift('self-hosted');

              const preferred = labelNames.includes('windows-prod')
                ? ['self-hosted','windows-prod']
                : labelNames;

              core.notice(`âœ… Runner selected: ${wanted.name}`);
              core.notice(`ğŸ·ï¸ Using labels: [${preferred.join(', ')}]`);
              core.setOutput('runs_on', JSON.stringify(preferred));
            } else {
              const fallback = "ubuntu-latest";
              core.notice(`ğŸŒ€ Fallback runner selected: ${fallback}`);
              core.setOutput('runs_on', JSON.stringify(fallback));
            }

      - name: Show decision output
        run: echo "runs_on=${{ steps.decide.outputs.runs_on }}"

  # 1) Detect services (váº«n cháº¡y GitHub-hosted Ä‘á»ƒ cÃ³ bash/apt)
  detect-services:
    runs-on: ubuntu-latest
    needs: pick-runner
    outputs:
      services: ${{ steps.out.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute smart diff & map to services (with verbose logs)
        id: out
        shell: bash
        env:
          BEFORE: ${{ github.event.before }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail

          # ==== Config =========================================================
          # Danh sÃ¡ch service chuáº©n (thÃªm aimoderation.api náº¿u cÃ³ code map)
          ALL_SERVICES=(
            "aimoderation.api"
            "alias.api" "auth.api" "chatbox.api" "digitalgoods.api" "feed.api" "media.api" "realtimehub.api"
            "payment.api" "post.api" "profile.api" "promotion.grpc"
            "subscription.api" "test.api" "translation.api" "yarpapigateway"
          )

          # CÃ¡c file thay Ä‘á»•i Ä‘Æ°á»£c coi lÃ  "global dependency" â†’ build táº¥t cáº£
          # LÆ¯U Ã: náº¿u lockfile hay Ä‘á»•i lÃ m báº¡n build all quÃ¡ nhiá»u, cÃ¢n nháº¯c bá» 'packages.lock.json' á»Ÿ Ä‘Ã¢y
          GLOBAL_DEPS_PATTERNS=(
            "Directory.Packages.props"
            "nuget.config"
            "packages.lock.json"
            ".dockerignore"
          )

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” DETECT SERVICES (verbose) â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"
          echo "Event: ${EVENT_NAME}"
          echo "SHA:   $GITHUB_SHA"
          echo "------------------------------------------------------------------------"

          git fetch --no-tags --prune origin main >/dev/null 2>&1 || true

          # ==== XÃ¡c Ä‘á»‹nh commit base ===========================================
          if [[ -n "${BEFORE:-}" && "${BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
            BASE="${BEFORE}"
            BASE_REASON="github.event.before"
          else
            if git rev-parse -q --verify HEAD~1 >/dev/null; then
              BASE="$(git rev-parse HEAD~1)"
              BASE_REASON="HEAD~1"
            else
              BASE="$(git merge-base origin/main HEAD)"
              BASE_REASON="merge-base origin/main HEAD"
            fi
          fi

          echo "Diff range: ${BASE}..HEAD  (base by: ${BASE_REASON})"
          echo "------------------------------------------------------------------------"

          # ==== Láº¥y danh sÃ¡ch file thay Ä‘á»•i ====================================
          mapfile -t CHANGED_FILES < <(git diff --name-only --diff-filter=ACMR "${BASE}"..HEAD || true)

          echo "Changed files count: ${#CHANGED_FILES[@]}"
          if [[ ${#CHANGED_FILES[@]} -gt 0 ]]; then
            printf '%s\n' "${CHANGED_FILES[@]}" | awk '{printf "  â€¢ %s\n", $0}'
          else
            echo "  (no changed files)"
          fi
          echo "------------------------------------------------------------------------"

          # ==== Quyáº¿t Ä‘á»‹nh BUILD_ALL ===========================================
          BUILD_ALL=0
          BUILD_ALL_REASON=""

          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            BUILD_ALL=1
            BUILD_ALL_REASON="manual dispatch"
          fi

          if [[ ${#CHANGED_FILES[@]} -eq 0 && $BUILD_ALL -eq 0 ]]; then
            BUILD_ALL=1
            BUILD_ALL_REASON="no changed files"
          fi

          if [[ $BUILD_ALL -eq 0 ]]; then
            for f in "${CHANGED_FILES[@]}"; do
              for p in "${GLOBAL_DEPS_PATTERNS[@]}"; do
                if [[ "$f" == "$p" ]]; then
                  BUILD_ALL=1
                  BUILD_ALL_REASON="global dep matched: ${p}"
                  break 2
                fi
              done
            done
          fi

          if [[ $BUILD_ALL -eq 1 ]]; then
            echo "âš ï¸ BUILD_ALL=1 â†’ reason: ${BUILD_ALL_REASON}"
          else
            echo "âœ… BUILD_ALL=0 â†’ selective build by path mapping"
          fi
          echo "------------------------------------------------------------------------"

          # ==== Map file â†’ service =============================================
          declare -A SVC_SET=()
          add_svc(){ SVC_SET["$1"]=1; }

          if [[ $BUILD_ALL -eq 1 ]]; then
            echo "Adding ALL services to build set:"
            printf '  â€¢ %s\n' "${ALL_SERVICES[@]}"
            for s in "${ALL_SERVICES[@]}"; do add_svc "$s"; done
          else
            echo "Mapping changed files to services:"
            printf "%-60s | %s\n" "File" "Service(+)"
            printf -- "--------------------------------------------------------------------------|-----------------\n"
            for f in "${CHANGED_FILES[@]}"; do
              matched=""
              case "$f" in
                Services/AIModeration/AIModeration.API/*|PsychologySupport/Services/AIModeration/AIModeration.API/*)   add_svc "aimoderation.api"; matched="aimoderation.api" ;;
                Services/Alias/Alias.API/*|PsychologySupport/Services/Alias/Alias.API/*)                     add_svc "alias.api"; matched="alias.api" ;;
                Services/Auth/Auth.API/*|PsychologySupport/Services/Auth/Auth.API/*)                         add_svc "auth.api"; matched="auth.api" ;;
                Services/ChatBox/ChatBox.API/*|PsychologySupport/Services/ChatBox/ChatBox.API/*)             add_svc "chatbox.api"; matched="chatbox.api" ;;
                Services/DigitalGoods/DigitalGoods.API/*|PsychologySupport/Services/DigitalGoods/DigitalGoods.API/*) add_svc "digitalgoods.api"; matched="digitalgoods.api" ;;
                Services/Feed/Feed.API/*|PsychologySupport/Services/Feed/Feed.API/*)                         add_svc "feed.api"; matched="feed.api" ;;
                Services/Media/Media.API/*|PsychologySupport/Services/Media/Media.API/*)                     add_svc "media.api"; matched="media.api" ;;
                Services/RealtimeHub/RealtimeHub.API/*|PsychologySupport/Services/RealtimeHub/RealtimeHub.API/*) add_svc "realtimehub.api"; matched="realtimehub.api" ;;
                Services/Payment/Payment.API/*|PsychologySupport/Services/Payment/Payment.API/*)             add_svc "payment.api"; matched="payment.api" ;;
                Services/Post/Post.API/*|PsychologySupport/Services/Post/Post.API/*)                         add_svc "post.api"; matched="post.api" ;;
                Services/Profile/Profile.API/*|PsychologySupport/Services/Profile/Profile.API/*)             add_svc "profile.api"; matched="profile.api" ;;
                Services/Promotion/Promotion.Grpc/*|PsychologySupport/Services/Promotion/Promotion.Grpc/*)   add_svc "promotion.grpc"; matched="promotion.grpc" ;;
                Services/Subscription/Subscription.API/*|PsychologySupport/Services/Subscription/Subscription.API/*) add_svc "subscription.api"; matched="subscription.api" ;;
                Services/Test/Test.API/*|PsychologySupport/Services/Test/Test.API/*)                         add_svc "test.api"; matched="test.api" ;;
                Services/Translation/Translation.API/*|PsychologySupport/Services/Translation/Translation.API/*) add_svc "translation.api"; matched="translation.api" ;;
                ApiGateways/YarpApiGateway/*|PsychologySupport/ApiGateways/YarpApiGateway/*)                 add_svc "yarpapigateway"; matched="yarpapigateway" ;;
              esac
              printf "%-60s | %s\n" "$f" "${matched:--}"
            done
          fi
          echo "------------------------------------------------------------------------"

          # ==== Náº¿u chÆ°a detect Ä‘Æ°á»£c service nÃ o, fallback build-all ============
          if [[ ${#SVC_SET[@]} -eq 0 ]]; then
            echo "â„¹ï¸ No service detected from changes. Fallback: ALL_SERVICES."
            for s in "${ALL_SERVICES[@]}"; do add_svc "$s"; done
          fi

          # ==== Xuáº¥t káº¿t quáº£ ====================================================
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y >/dev/null 2>&1 && sudo apt-get install -y jq >/dev/null 2>&1
          fi

          printf '%s\n' "${!SVC_SET[@]}" | sort | jq -R -s -c 'split("\n") - [""]' > services.json
          echo "Detected services JSON: $(cat services.json)"
          echo "services=$(cat services.json)" >> "$GITHUB_OUTPUT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” END DETECT â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

  # 2) Build job â€“ cháº¡y trÃªn runner Ä‘Ã£ chá»n (self-hosted náº¿u online, ngÆ°á»£c láº¡i ubuntu-latest)
  build:
    needs: [pick-runner, detect-services]
    if: ${{ needs.detect-services.outputs.services != '[]' }}
    runs-on: ${{ fromJson(needs.pick-runner.outputs.runs_on) }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-services.outputs.services) }}
    steps:
      - name: Using which runner?
        run: echo "Using runs-on=${{ needs.pick-runner.outputs.runs_on }}; Service=${{ matrix.service }}"
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (using your PAT secrets)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GIT_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.GIT_CONTAINER_REGISTRY_PASSWORD }}

      - name: Resolve context & dockerfile
        id: meta
        shell: bash   # <- cáº§n Git Bash náº¿u cháº¡y Windows self-hosted
        run: |
          set -euo pipefail
          SVC="${{ matrix.service }}"

          case "$SVC" in
            aimoderation.api) CANDS=( "Services/AIModeration/AIModeration.API/Dockerfile" "PsychologySupport/Services/AIModeration/AIModeration.API/Dockerfile" ) ;;
            alias.api)        CANDS=( "Services/Alias/Alias.API/Dockerfile" "PsychologySupport/Services/Alias/Alias.API/Dockerfile" ) ;;
            auth.api)         CANDS=( "Services/Auth/Auth.API/Dockerfile" "PsychologySupport/Services/Auth/Auth.API/Dockerfile" ) ;;
            chatbox.api)      CANDS=( "Services/ChatBox/ChatBox.API/Dockerfile" "PsychologySupport/Services/ChatBox/ChatBox.API/Dockerfile" ) ;;
            digitalgoods.api) CANDS=( "Services/DigitalGoods/DigitalGoods.API/Dockerfile" "PsychologySupport/Services/DigitalGoods/DigitalGoods.API/Dockerfile" ) ;;
            feed.api)         CANDS=( "Services/Feed/Feed.API/Dockerfile" "PsychologySupport/Services/Feed/Feed.API/Dockerfile" ) ;;
            media.api)        CANDS=( "Services/Media/Media.API/Dockerfile" "PsychologySupport/Services/Media/Media.API/Dockerfile" ) ;;
            realtimehub.api)  CANDS=( "Services/RealtimeHub/RealtimeHub.API/Dockerfile" "PsychologySupport/Services/RealtimeHub/RealtimeHub.API/Dockerfile" ) ;;
            payment.api)      CANDS=( "Services/Payment/Payment.API/Dockerfile" "PsychologySupport/Services/Payment/Payment.API/Dockerfile" ) ;;
            post.api)         CANDS=( "Services/Post/Post.API/Dockerfile" "PsychologySupport/Services/Post/Post.API/Dockerfile" ) ;;
            profile.api)      CANDS=( "Services/Profile/Profile.API/Dockerfile" "PsychologySupport/Services/Profile/Profile.API/Dockerfile" ) ;;
            promotion.grpc)   CANDS=( "Services/Promotion/Promotion.Grpc/Dockerfile" "PsychologySupport/Services/Promotion/Promotion.Grpc/Dockerfile" ) ;;
            subscription.api) CANDS=( "Services/Subscription/Subscription.API/Dockerfile" "PsychologySupport/Services/Subscription/Subscription.API/Dockerfile" ) ;;
            test.api)         CANDS=( "Services/Test/Test.API/Dockerfile" "PsychologySupport/Services/Test/Test.API/Dockerfile" ) ;;
            translation.api)  CANDS=( "Services/Translation/Translation.API/Dockerfile" "PsychologySupport/Services/Translation/Translation.API/Dockerfile" ) ;;
            yarpapigateway)   CANDS=( "ApiGateways/YarpApiGateway/Dockerfile" "PsychologySupport/ApiGateways/YarpApiGateway/Dockerfile" ) ;;
            *) echo "Unknown service $SVC"; exit 1 ;;
          esac

          DF=""
          for p in "${CANDS[@]}"; do
            if [[ -f "$p" ]]; then DF="$p"; break; fi
          done

          if [[ -z "$DF" ]]; then
            echo "âŒ Dockerfile not found for $SVC"; printf 'Tried:\n- %s\n' "${CANDS[@]}"; exit 1
          fi

          if [[ "$DF" == PsychologySupport/* ]]; then
            CTX="PsychologySupport"
          else
            CTX="."
          fi

          echo "CTX=$CTX" >> $GITHUB_OUTPUT
          echo "DF=$DF" >> $GITHUB_OUTPUT
          echo "Resolved CTX=$CTX, DF=$DF"

          OWNER_LC=$(echo "${{ env.OWNER }}" | tr '[:upper:]' '[:lower:]')
          SVC_LC=$(echo "$SVC" | tr '[:upper:]' '[:lower:]')
          echo "IMG=ghcr.io/${OWNER_LC}/${SVC_LC}" >> $GITHUB_OUTPUT

      - name: Build & Push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ steps.meta.outputs.CTX }}
          file: ${{ steps.meta.outputs.DF }}
          platforms: linux/amd64
          push: true
          provenance: false
          tags: |
            ${{ steps.meta.outputs.IMG }}:${{ github.sha }}
            ${{ steps.meta.outputs.IMG }}:latest
            ${{ steps.meta.outputs.IMG }}:main
