name: Deploy to VPS on push

on:
  push:
    branches:
      - main

jobs:
  #Sync base secrets (appsettings.json, .env, RSA,...)
  sync-base-secrets:
    uses: ./.github/workflows/sync-secrets.yml
    secrets: inherit

  #Sync appsettings.Production.json
  sync-production-appsettings:
    uses: ./.github/workflows/sync-production-appsettings.yml
    secrets: inherit

  #Deploy app (build & up docker)
  deploy:
    runs-on: ubuntu-latest
    needs: [sync-base-secrets, sync-production-appsettings]
    environment: Production
    steps:
      - name: Build & deploy updated microservices
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /home/root/emoease/PsychologySupport

            git reset --hard HEAD
            git pull origin main

            CHANGED=$(git diff --name-only HEAD^ HEAD \
              | grep -E '^PsychologySupport/Services/[^/]+/|^PsychologySupport/ApiGateways/[^/]+' \
              | awk -F/ '{
                  if ($1 == "PsychologySupport" && $2 == "Services") {
                    print tolower($3) ".api"
                  } else if ($1 == "PsychologySupport" && $2 == "ApiGateways") {
                    print tolower($3)
                  }
                }' \
              | sort -u)

            echo "================= DEBUGGING ================="
            echo "*** Changed Microservices: $CHANGED"
            echo "============================================="

            for svc in $CHANGED; do
              (
                echo "üî® [$(date +%T)] B·∫Øt ƒë·∫ßu build $svc"
                if docker compose -f docker-compose-apis.yml build "$svc"; then
                  echo "‚úÖ [$(date +%T)] Build th√†nh c√¥ng $svc"
                else
                  echo "‚ùå [$(date +%T)] Build th·∫•t b·∫°i $svc"
                fi
              ) &
            done
            wait
            
            for svc in $CHANGED; do
              (
                echo "üöÄ [$(date +%T)] Successfully built $svc"
                if docker compose -f docker-compose-apis.yml up -d "$svc"; then
                  echo "‚úÖ [$(date +%T)] Successfully Up $svc"
                else
                  echo "‚ùå [$(date +%T)] Up failed $svc"
                fi
              ) &
            done
            wait
            
            echo "=== All services have been updated successfully ==="

            # docker builder prune -f
            # echo "‚úÖ Docker cache cleaned."
