name: Sync Production Appsettings To VPS

on:
  workflow_call:
    secrets:
      VPS_HOST:
        required: true
      VPS_USERNAME:
        required: true
      VPS_PASSWORD:
        required: true
      APPSETTINGS_PRODUCTION_AUTH_API:
        required: true
      APPSETTINGS_PRODUCTION_CHATBOX:
        required: true
      APPSETTINGS_PRODUCTION_IMAGE:
        required: true
      APPSETTINGS_PRODUCTION_LIFESTYLES:
        required: true
      APPSETTINGS_PRODUCTION_NOTIFICATION:
        required: true
      APPSETTINGS_PRODUCTION_PAYMENT:
        required: true
      APPSETTINGS_PRODUCTION_PROFILE:
        required: true
      APPSETTINGS_PRODUCTION_PROMOTION:
        required: true
      APPSETTINGS_PRODUCTION_SCHEDULING:
        required: true
      APPSETTINGS_PRODUCTION_SUBSCRIPTION:
        required: true
      APPSETTINGS_PRODUCTION_TRANSLATION:
        required: true
      # --------- NEW SECRETS FOR MISSING SERVICES ----------
      APPSETTINGS_PRODUCTION_AIMODERATION:
        required: true
      APPSETTINGS_PRODUCTION_ALIAS:
        required: true
      APPSETTINGS_PRODUCTION_BILLING:
        required: true
      APPSETTINGS_PRODUCTION_DIGITALGOODS:
        required: true
      APPSETTINGS_PRODUCTION_FEED:
        required: true
      APPSETTINGS_PRODUCTION_MEDIA:
        required: true
      APPSETTINGS_PRODUCTION_POST:
        required: true
      APPSETTINGS_PRODUCTION_USERMEMORY:
        required: true
      # -----------------------------------------------------
  workflow_dispatch:

jobs:
  sync-production:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Sync production appsettings for all services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /home/emoease/PsychologySupport

            # Auth
            cat <<EOF > Services/Auth/Auth.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_AUTH_API }}
            EOF

            # ChatBox
            cat <<EOF > Services/ChatBox/ChatBox.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_CHATBOX }}
            EOF

            # Image
            cat <<EOF > Services/Image/Image.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_IMAGE }}
            EOF

            # LifeStyles
            cat <<EOF > Services/LifeStyles/LifeStyles.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_LIFESTYLES }}
            EOF

            # Notification
            cat <<EOF > Services/Notification/Notification.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_NOTIFICATION }}
            EOF

            # Payment
            cat <<EOF > Services/Payment/Payment.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_PAYMENT }}
            EOF

            # Profile
            cat <<EOF > Services/Profile/Profile.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_PROFILE }}
            EOF

            # Promotion (gRPC)
            cat <<EOF > Services/Promotion/Promotion.Grpc/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_PROMOTION }}
            EOF

            # Scheduling
            cat <<EOF > Services/Scheduling/Scheduling.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_SCHEDULING }}
            EOF

            # Subscription
            cat <<EOF > Services/Subscription/Subscription.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_SUBSCRIPTION }}
            EOF

            # Test
            cat <<EOF > Services/Test/Test.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_TEST }}
            EOF

            # Translation
            cat <<EOF > Services/Translation/Translation.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_TRANSLATION }}
            EOF

            # ================== NEW SERVICES ==================

            # AIModeration
            cat <<EOF > Services/AIModeration/AIModeration.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_AIMODERATION }}
            EOF

            # Alias
            cat <<EOF > Services/Alias/Alias.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_ALIAS }}
            EOF

            # Billing
            cat <<EOF > Services/Billing/Billing.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_BILLING }}
            EOF

            # DigitalGoods
            cat <<EOF > Services/DigitalGoods/DigitalGoods.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_DIGITALGOODS }}
            EOF

            # Feed
            cat <<EOF > Services/Feed/Feed.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_FEED }}
            EOF

            # Realtime Hub
            cat <<EOF > Services/RealtimeHub/RealtimeHub.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_REALTIME_HUB }}
            EOF

            # Media
            cat <<EOF > Services/Media/Media.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_MEDIA }}
            EOF

            # UserMemory
            cat <<EOF > Services/UserMemory/UserMemory.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_UserMemory }}
            EOF

            # Post
            cat <<EOF > Services/Post/Post.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_POST }}
            EOF

            # Wellness
            cat <<EOF > Services/Wellness/Wellness.API/appsettings.Production.json
            ${{ secrets.APPSETTINGS_PRODUCTION_WELLNESS }}
            EOF

            # # YARP ApiGateway
            # cat <<EOF > ApiGateways/YarpApiGateway/appsettings.Production.json
            # ${{ secrets.APPSETTINGS_PRODUCTION_YARP_API_GATEWAY }}
            # EOF

            # ==================================================

            echo "âœ… Sync production appsettings done!"
